# 基本設計

設計中、開発中に限らず今後必要になる機能と基本設計を記載する。  
各一覧ページへは、サイドバーからの遷移を想定。

**機能一覧**

- 認証
- ダッシュボード
- ユーザ管理(Admin のみ)
- 発注管理
- クライアント管理
- 製品管理
- 部品管理

## 認証

今後 Google アカウントでのログインをできるようにするため、認証については AWS Cognito を利用する。  
Ph1 では、本アプリ専用のアカウントを作成する。

認可の部分やユーザーの名前管理、組織管理などは Cognito の uuid を使って DB 側で管理をする。

ログイン画面にはメールアドレスとパスワードの入力欄のみを表示する。  
ログインに成功すると、ワンタイムパスワードを入力する画面を表示する。  
常に二段階認証をオンにし、6 桁の数字を必ずいれるようにする。

## ダッシュボード

Ph1 ではログイン後の遷移先は発注一覧とし、ダッシュボード機能は設けない。

**必要そうな機能**

- 部品数から各製品が何台作れるかを計算し表示する
- 今発注されている分の製品数分の部品数を引いた部品数を表示する。
- なくなりそうな足りていない部品を表示する。
- 各製品何台発注が来ているかのサマリを表示する。
- 汎用メッセージ欄を表示する。

## ユーザ管理(Admin のみ)

**ページ一覧**

- ユーザ一覧
- ユーザ登録
- ユーザ編集

Ph1 ではユーザは必ず１つだけの組織に所属する必要がある。  
今後、複数組織に登録できるような改修を行う必要がある。  
ユーザーを組織に招待する機能。

組織に属する個人が自分のユーザ情報を変更することはできない設定とする。  
Admin 権限のみ編集が可能。

### ユーザ一覧

テーブル表示とする。

**テーブルの 1 行に必要な項目**

- 名前
- メールアドレス
- 権限
- ユーザ有効状態(招待メールからアカウントを有効にしたかどうか)
- 編集ボタン(ユーザ編集画面遷移)

#### その他・必要な機能

- ユーザ登録ページ遷移

### ユーザ登録

#### 登録に必要な項目

- 名前
- メールアドレス
- 権限

#### ユーザ登録フロー

ユーザは組織の Admin から招待を受けることでユーザを作成することができる。  
追加したいユーザのメールアドレス宛に招待リンクを送り、リンク先にアクセスする。  
リンク先にアクセスするとパスワードを設定する画面が表示されるので、パスワードを設定するとログイン画面からログインするように案内を表示する。

### ユーザ編集

基本的にはユーザ登録と同じ。
招待メールの再送ボタンとユーザの削除ボタンだけ追加する。

## 発注管理

**ページ一覧**

- 発注一覧
- 発注登録
- 発注編集

### 発注一覧

どのクライアントからどの製品が何台発注されているかを表示する。  
初期登録時は受注、出荷済みの二種類の状態をもつ。  
状態は増える可能性があるためフラグを追加できる必要がある。

一覧表示は、テーブルでの表示とする。

#### テーブルの 1 行に表示する項目

- クライアント名
- 製品
- 数
- 出荷予定日
- 出荷日
- 備考欄
- 出荷済み処理ボタン
- 編集ページ遷移ボタン

#### その他・必要な機能

- 発注登録ページ遷移
- 出荷済み処理
- 出荷済み表示トグル

出荷済み処理は、一覧表示画面においても操作可能とする。

#### 出荷済み処理

出荷済み処理は、出荷済み処理をした日時を持つカラムに日時を追加することをフラグとする。  
削除は誤って操作してしまう場合を考え、編集画面でのみの操作とする。

誤って出荷済みとしてしまった場合は、編集画面に入って出荷済み解除ボタンを押す。

製品の在庫がない場合は、出荷済み処理ができないものとする。
出荷済み処理をしたい際に在庫がない場合は、在庫補充・廃棄機能をつかって補充する。

出荷した分在庫数を減らす。

#### 絞り込み機能

絞り込み機能は、検索までいれると複雑になるため Ph1 では出荷予定日昇順 + 未出荷のもののみで初期表示。  
出荷済みのものを表示する場合はトグルボタンを操作する。  
Ph1 では表示順は固定表示とする。

### 発注登録

#### 登録に必要な項目

- クライアント(ドロップダウンから選択する)
- 製品(ドロップダウンから選択する)
- 数
- 出荷予定日(カレンダーから選択する)
- 備考

クライアント、製品はドロップダウンメニューから選べるようにする。  
Ph1 では存在しないクライアントや製品は登録できないようにする。

Ph2 では登録されていないクライアントや製品が登録できないと不便なため、その他選択肢を用意して、備考欄必須で登録可とする対応をいれる。

### 発注編集

登録画面の流用で基本的には OK。  
加えて出荷済みボタン、出荷済み解除ボタン、削除ボタンを設置する。  
削除処理はソフトデリートとして deleted_at をテーブルに登録する。  
排他制御は Ph1 では考慮しない。

## クライアント管理

**ページ一覧**

- クライアント一覧
- クライアント登録
- クライアント編集

### クライアント一覧表示

一覧表示は、テーブルでの表示とする。

#### テーブルの 1 行に表示する項目

- クライアント名
- メールアドレス
- 備考欄
- 編集ページ遷移ボタン

#### その他・必要な機能

- クライアント登録ページ遷移

### クライアント登録

#### 登録に必要な項目

- 名前
- 担当者メールアドレス
- 備考

### クライアント編集

登録と同じで問題ない。

## 製品管理

**ページ一覧**

- 製品一覧
- 製品情報登録
- 製品情報編集
- 製品在庫補充・廃棄
- 製品在庫増減履歴(Ph1 では画面として対応しないがデータは DB にもつ)

### 製品一覧

一覧表示は、テーブルでの表示とする。

#### テーブルの 1 行に表示する項目

- 製品名
- 在庫数
- 上代(税抜き)
- 下代(税抜き)
- JAN コード
- 備考欄
- 製品在庫補充・廃棄画面遷移ボタン
- 製品情報編集画面遷移ボタン

#### その他・必要な機能

- 製品情報登録ページ遷移
- 製品補充・廃棄履歴ページ遷移

製品の個数については、部品数増減履歴から計算したものを表示する。

#### 製品在庫補充・廃棄について

製品在庫補充の場合は紐づく部品の在庫を計算し減らす必要がある。

また、製品在庫増減テーブルに補充・廃棄を登録しつつ現在の在庫数を製品テーブルにも保存する。  
製品テーブルの在庫数はユーザから直接編集できないようにし、増減の履歴から計算したものを保存する。  
二重管理ぽくなるが、取得時に SQL がシンプルになるためあえてこういう仕様とする。

### 製品情報登録

#### 登録に必要な項目

- 製品名
- バージョン
- JAN コード
- 上代(税抜き)
- 下代(税抜き)
- 使用部品
- 備考

その製品を 1 つ作るのに必要な使用部品を紐づける必要がある。  
以下の情報が必要。

- 部品名(ドロップダウンより)
- 個数

データが不整合になることを防ぐため、1 度登録した部品の紐づきは編集できないようにする。  
ただし、1 度もその製品を作成していない場合は編集可能とする。  
部品の結びつけを変えたい場合はバージョンアップで別のものを作成する。  
製品の複製登録機能が必要。

#### 製品複製登録機能

バージョンアップ等で製品の情報(部品のひも付きなどが変わった場合)を変更したい場合は、既存の製品情報から情報を引き継いで登録画面の初期値として入力しておく。

### 製品情報編集

基本的に登録と同じ。  
製品を削除するとややこしいので削除はできないようにする。  
製品テーブルの在庫数はユーザから直接編集できないようにし、増減の履歴から計算したものを保存する。  
二重管理ぽくなるが、取得時に SQL がシンプルになるためあえてこういう仕様とする。

### 製品補充・廃棄

#### 登録に必要な項目

- 製品名(ドロップダウンから選択する)
- 補充・廃棄トグル
- 数量
- 備考

製品在庫の増減履歴を残していくような形にする。  
部品在庫と同じような仕様にする。  
毎回、在庫数を SQL で計算して取得すると複雑になるため製品テーブルにも在庫数を持つ方針に変更。  
ユーザから直接在庫数は編集できないようにし、増減発生時に増減の履歴から計算したものを保存する。

製品が壊れてしまった等は廃棄を選択し値を入力することで、製品の廃棄を表す。

## 部品管理

**ページ一覧**

- 部品一覧
- 部品情報登録
- 部品情報編集
- 部品補充・廃棄
- 部品在庫増減履歴(Ph1 では画面として対応しないがデータは DB にもつ)

### 部品一覧

一覧表示は、テーブルでの表示とする。

#### テーブルの 1 行に表示する項目

- 部品名
- 個数
- 単価(税抜き)
- 備考欄
- 補充画面遷移ボタン
- 部品情報編集画面遷移ボタン

#### その他・必要な機能

- 部品登録ページ遷移
- 部品増減履歴ページ遷移

### 部品情報登録

部品マスタという扱い。

#### 登録に必要な項目

- 部品名
- 部品メーカー
- カテゴリ(ドロップダウンから選択する)
- 備考

### 部品情報編集

基本的に登録と同じ。  
部品を削除するとややこしいので削除はできないようにする。  
部品テーブルの在庫数はユーザから直接編集できないようにし、増減発生時に増減の履歴から計算したものを保存する。  
二重管理ぽくなるが、取得時に SQL がシンプルになるためあえてこういう仕様とする。

### 部品補充・廃棄

#### 登録に必要な項目

- 部品名(ドロップダウンから選択する)
- 補充・廃棄トグル
- 数量
- 備考

部品は補充という形で購入履歴を残していくような形にする。  
理由としては以下のようなものがある。

- 棚卸しの際に必要となるので、購入した際の金額と日時はデータとして持ちたい。最終仕入原価法で計算することができるようにする。
- 外貨か日本円かが場合によって異なることがある。
- 部品の値上がりなどの情報を残しておきたい
- 部品数を物理的に更新してしまうと誤って変な値で更新してしまった場合の取り返しがつきにくい

~~これによって、部品数や補充の回数が増えると 一覧表示時に DB の読み込み負荷が増える可能性があるため、読み込み負荷については気をつけておく必要がある。~~
SQL が複雑になるため部品テーブルにも在庫数を持つ方針に変更。  
ユーザから直接在庫数は編集できないようにし、増減の履歴から計算したものを保存する。

部品が壊れてしまった等は廃棄を選択し値を入力することで、部品の廃棄を表す。
